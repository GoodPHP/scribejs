/* scribejs-editor v0.1.0 */
var C=class{constructor(e,n){this.savedRange=null;this.doc=e,this.contentEl=n}isSelectionInContent(){let e=this.doc.getSelection();if(!e||e.rangeCount===0)return!1;let n=e.getRangeAt(0);return this.contentEl.contains(n.commonAncestorContainer)}getSelection(){let e=this.doc.getSelection();if(!e||e.rangeCount===0)return null;let n=e.getRangeAt(0);if(!this.contentEl.contains(n.commonAncestorContainer))return null;let i=e.toString(),r=n.collapsed,s=null;if(!r){let d=n.getClientRects();if(d.length>0){let c=d[0],h=d[d.length-1],p=Math.min(c.left,h.left),b=c.top,f=Math.max(c.right,h.right),a=h.bottom;s=new DOMRect(p,b,f-p,a-b)}}return{range:n.cloneRange(),collapsed:r,text:i,rect:s,formats:this.getFormats(n)}}getFormats(e){let n=this.doc.getSelection();if(!n||n.rangeCount===0)return this.getDefaultFormats();let r=(e||n.getRangeAt(0)).commonAncestorContainer,s=r.nodeType===Node.TEXT_NODE?r.parentElement:r;if(!s)return this.getDefaultFormats();let d=window.getComputedStyle(s);return{bold:this.hasFormat(s,"b")||this.hasFormat(s,"strong")||parseInt(d.fontWeight)>=700,italic:this.hasFormat(s,"i")||this.hasFormat(s,"em")||d.fontStyle==="italic",underline:this.hasFormat(s,"u")||d.textDecoration.includes("underline"),strike:this.hasFormat(s,"s")||this.hasFormat(s,"strike")||this.hasFormat(s,"del")||d.textDecoration.includes("line-through"),code:this.hasFormat(s,"code"),link:this.getLinkUrl(s),heading:this.getHeadingLevel(s),list:this.getListType(s),blockquote:this.hasFormat(s,"blockquote"),align:this.getAlignment(s,d)}}getDefaultFormats(){return{bold:!1,italic:!1,underline:!1,strike:!1,code:!1,link:null,heading:null,list:null,blockquote:!1,align:"left"}}hasFormat(e,n){let i=e;for(;i&&i!==this.contentEl;){if(i.tagName.toLowerCase()===n.toLowerCase())return!0;i=i.parentElement}return!1}getLinkUrl(e){let n=e;for(;n&&n!==this.contentEl;){if(n.tagName.toLowerCase()==="a")return n.href||null;n=n.parentElement}return null}getHeadingLevel(e){let n=e;for(;n&&n!==this.contentEl;){let i=n.tagName.match(/^H([1-6])$/i);if(i)return parseInt(i[1]);n=n.parentElement}return null}getListType(e){let n=e;for(;n&&n!==this.contentEl;){if(n.tagName.toLowerCase()==="ol")return"ordered";if(n.tagName.toLowerCase()==="ul")return"unordered";n=n.parentElement}return null}getAlignment(e,n){let i=n.textAlign;return i==="center"||i==="right"||i==="justify"?i:"left"}saveSelection(){let e=this.doc.getSelection();e&&e.rangeCount>0&&(this.savedRange=e.getRangeAt(0).cloneRange())}restoreSelection(){if(!this.savedRange)return!1;let e=this.doc.getSelection();return e?(e.removeAllRanges(),e.addRange(this.savedRange),!0):!1}clearSavedSelection(){this.savedRange=null}setSelection(e){let n=this.doc.getSelection();n&&(n.removeAllRanges(),n.addRange(e))}selectAll(){let e=this.doc.createRange();e.selectNodeContents(this.contentEl),this.setSelection(e)}collapse(e=!1){let n=this.doc.getSelection();!n||n.rangeCount===0||(e?n.collapseToStart():n.collapseToEnd())}getCursorPosition(){let e=this.doc.getSelection();if(!e||e.rangeCount===0)return null;let n=e.getRangeAt(0),i=n.getBoundingClientRect();if(i.width===0&&i.height===0){let r=this.doc.createElement("span");r.textContent="\u200B",n.insertNode(r);let s=r.getBoundingClientRect();return r.parentNode?.removeChild(r),{top:s.top,left:s.left,height:s.height||20}}return{top:i.top,left:i.left,height:i.height}}getSelectionRect(){let e=this.doc.getSelection();return!e||e.rangeCount===0?null:e.getRangeAt(0).getBoundingClientRect()}getSelectionOffsets(){let e=this.getSelection();if(!e||!e.range)return null;let n=e.range,i=n.cloneRange();i.selectNodeContents(this.contentEl),i.setEnd(n.startContainer,n.startOffset);let r=i.toString().length;return{start:r,end:r+n.toString().length}}};var P=["p","br","hr","h1","h2","h3","h4","h5","h6","strong","b","em","i","u","s","strike","del","sup","sub","code","pre","blockquote","q","ul","ol","li","a","img","table","thead","tbody","tfoot","tr","th","td","div","span","figure","figcaption"],N={"*":["class","id","style","data-*"],a:["href","target","rel","title"],img:["src","alt","width","height","title"],td:["colspan","rowspan"],th:["colspan","rowspan","scope"]},I=["http","https","mailto","tel"],z=["script","style","iframe","object","embed","form","input","button"],y=class{constructor(e={}){this.config={allowedTags:e.allowedTags||P,allowedAttributes:e.allowedAttributes||N,allowedSchemes:e.allowedSchemes||I,stripEmpty:e.stripEmpty??!0}}sanitize(e){let i=new DOMParser().parseFromString(e,"text/html").body;return this.processNode(i),i.innerHTML}processNode(e){let n=Array.from(e.childNodes);for(let c=n.length-1;c>=0;c--)this.processNode(n[c]);if(e.nodeType!==Node.ELEMENT_NODE)return;let i=e,r=i.tagName.toLowerCase();if(z.includes(r)){i.remove();return}if(!this.config.allowedTags.includes(r)){let c=i.parentNode;if(c){for(;i.firstChild;)c.insertBefore(i.firstChild,i);i.remove()}return}let s=this.getAllowedAttributes(r),d=Array.from(i.attributes);for(let c of d){if(!this.isAttributeAllowed(c.name,s)){i.removeAttribute(c.name);continue}["href","src"].includes(c.name)&&(this.isUrlSafe(c.value)||i.removeAttribute(c.name)),c.name.startsWith("on")&&i.removeAttribute(c.name),c.name==="style"&&i.setAttribute("style",this.sanitizeStyle(c.value))}this.config.stripEmpty&&this.isEmpty(i)&&!["br","hr","img"].includes(r)&&i.remove()}getAllowedAttributes(e){let n=this.config.allowedAttributes["*"]||[],i=this.config.allowedAttributes[e]||[];return[...n,...i]}isAttributeAllowed(e,n){if(n.includes(e))return!0;for(let i of n)if(i.endsWith("*")){let r=i.slice(0,-1);if(e.startsWith(r))return!0}return!1}isUrlSafe(e){try{if(e.startsWith("/")||e.startsWith("./")||e.startsWith("../")||e.startsWith("data:image/"))return!0;let i=new URL(e,"http://example.com").protocol.slice(0,-1);return this.config.allowedSchemes.includes(i)}catch{return!1}}sanitizeStyle(e){let n=["expression","javascript:","behavior","binding","-moz-binding","url("],i=e;for(let r of n){let s=new RegExp(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");i=i.replace(s,"")}return i}isEmpty(e){return e.textContent?.trim()===""&&e.children.length===0}sanitizePaste(e){let n=e.replace(/<o:p[^>]*>[\s\S]*?<\/o:p>/gi,"").replace(/<\/?o:[^>]*>/gi,"").replace(/<!--\[if[^\]]*\]>[\s\S]*?<!\[endif\]-->/gi,"").replace(/<!--[\s\S]*?-->/g,"").replace(/<\/?xml[^>]*>/gi,"").replace(/<\/?st1:[^>]*>/gi,"").replace(/class="Mso[^"]*"/gi,"").replace(/style="[^"]*mso-[^"]*"/gi,"");return n=n.replace(/class="[^"]*docs-[^"]*"/gi,"").replace(/id="docs-[^"]*"/gi,""),n=n.replace(/\s+/g," ").replace(/>\s+</g,"><"),this.sanitize(n)}};var S=class{constructor(e=100){this.stack=[];this.position=-1;this.debounceTimer=null;this.debounceDelay=300;this.lastContent="";this.maxSize=e}push(e,n){e!==this.lastContent&&(this.lastContent=e,this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.addEntry(e,n)},this.debounceDelay))}pushImmediate(e,n){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),e!==this.lastContent&&(this.lastContent=e,this.addEntry(e,n))}addEntry(e,n){this.stack=this.stack.slice(0,this.position+1),this.stack.push({html:e,selection:n,timestamp:Date.now()}),this.stack.length>this.maxSize?this.stack.shift():this.position++}undo(){return this.canUndo()?(this.position--,this.stack[this.position]):null}redo(){return this.canRedo()?(this.position++,this.stack[this.position]):null}canUndo(){return this.position>0}canRedo(){return this.position<this.stack.length-1}getCurrent(){return this.position<0||this.position>=this.stack.length?null:this.stack[this.position]}clear(){this.stack=[],this.position=-1,this.lastContent="",this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}getStackSize(){return this.stack.length}getPosition(){return this.position}};var k={bold:t=>{t.getDocument().execCommand("bold",!1)},italic:t=>{t.getDocument().execCommand("italic",!1)},underline:t=>{t.getDocument().execCommand("underline",!1)},strike:t=>{t.getDocument().execCommand("strikeThrough",!1)},subscript:t=>{t.getDocument().execCommand("subscript",!1)},superscript:t=>{t.getDocument().execCommand("superscript",!1)},code:t=>{let e=t.getSelection();if(!e||e.collapsed)return;let n=t.getDocument(),i=e.range;if(i)if(e.formats.code){let r=R(i.commonAncestorContainer,"code");if(r){let s=r.parentNode;for(;r.firstChild;)s?.insertBefore(r.firstChild,r);r.remove()}}else{let r=n.createElement("code");r.appendChild(i.extractContents()),i.insertNode(r)}},clearFormat:t=>{t.getDocument().execCommand("removeFormat",!1)},heading:(t,e)=>{let n=e?`h${e}`:"p";t.getDocument().execCommand("formatBlock",!1,n)},paragraph:t=>{t.getDocument().execCommand("formatBlock",!1,"p")},blockquote:t=>{t.getSelection()?.formats.blockquote?t.getDocument().execCommand("formatBlock",!1,"p"):t.getDocument().execCommand("formatBlock",!1,"blockquote")},codeBlock:t=>{t.getDocument().execCommand("formatBlock",!1,"pre")},orderedList:t=>{t.getDocument().execCommand("insertOrderedList",!1)},unorderedList:t=>{t.getDocument().execCommand("insertUnorderedList",!1)},alignLeft:t=>{t.getDocument().execCommand("justifyLeft",!1)},alignCenter:t=>{t.getDocument().execCommand("justifyCenter",!1)},alignRight:t=>{t.getDocument().execCommand("justifyRight",!1)},alignJustify:t=>{t.getDocument().execCommand("justifyFull",!1)},indent:t=>{t.getDocument().execCommand("indent",!1)},outdent:t=>{t.getDocument().execCommand("outdent",!1)},link:(t,e)=>{if(typeof e!="string")return;let n=t.getSelection();if(n)if(n.formats.link){let i=n.range;if(!i)return;let r=R(i.commonAncestorContainer,"a");r&&(r.href=e)}else n.collapsed||t.getDocument().execCommand("createLink",!1,e)},unlink:t=>{t.getDocument().execCommand("unlink",!1)},insertHR:t=>{t.getDocument().execCommand("insertHorizontalRule",!1)},insertHTML:(t,e)=>{typeof e=="string"&&t.getDocument().execCommand("insertHTML",!1,e)},insertText:(t,e)=>{typeof e=="string"&&t.getDocument().execCommand("insertText",!1,e)},selectAll:t=>{t.getDocument().execCommand("selectAll",!1)},undo:t=>{t.emit("undo")},redo:t=>{t.emit("redo")},setFontSize:(t,e)=>{if(typeof e!="string"&&typeof e!="number")return;let n=t.getSelection();if(!n||n.collapsed)return;let i=t.getDocument(),r=n.range;if(!r)return;let s=i.createElement("span");s.style.fontSize=typeof e=="number"?`${e}px`:e,s.appendChild(r.extractContents()),r.insertNode(s)},setFontFamily:(t,e)=>{typeof e=="string"&&t.getDocument().execCommand("fontName",!1,e)},setColor:(t,e)=>{typeof e=="string"&&t.getDocument().execCommand("foreColor",!1,e)},setBackgroundColor:(t,e)=>{typeof e=="string"&&t.getDocument().execCommand("hiliteColor",!1,e)}};function R(t,e){let n=t;for(;n;){if(n.nodeType===Node.ELEMENT_NODE&&n.tagName.toLowerCase()===e.toLowerCase())return n;n=n.parentNode}return null}var L=[{key:"b",ctrl:!0,command:"bold"},{key:"i",ctrl:!0,command:"italic"},{key:"u",ctrl:!0,command:"underline"},{key:"z",ctrl:!0,command:"undo"},{key:"z",ctrl:!0,shift:!0,command:"redo"},{key:"y",ctrl:!0,command:"redo"},{key:"\\",ctrl:!0,command:"clearFormat"},{key:"k",ctrl:!0,command:"link"}];function v(t){let e=typeof t.target=="string"?document.querySelector(t.target):t.target;if(!e)throw new Error("Scribe: Target element not found");let n=t.iframe?.contentDocument||e.ownerDocument;if(!n)throw new Error("Scribe: Could not access document");let i=new C(n,e),r=new y(t.sanitize),s=new S,d=!1,c=t.readOnly??!1,h=new Map,p=new Map,b=[...L],f=new Map,a=e;c||(a.contentEditable="true"),a.classList.add("scribe-editor","scribe-content"),t.placeholder&&a.setAttribute("data-placeholder",t.placeholder),Object.entries(k).forEach(([o,m])=>{p.set(o,m)});let l=(o,...m)=>{if(c)return;let g=p.get(o);g&&(g(u,...m),s.push(a.innerHTML,null),u.emit("change",a.innerHTML),t.onChange?.(a.innerHTML),requestAnimationFrame(()=>{u.emit("selectionChange",i.getSelection())}))},u={getDocument:()=>n,getContentElement:()=>a,getSelection:()=>i.getSelection(),exec:(o,...m)=>l(o,...m),canExec:o=>p.has(o)&&!c,bold:()=>l("bold"),italic:()=>l("italic"),underline:()=>l("underline"),strike:()=>l("strike"),code:()=>l("code"),subscript:()=>l("subscript"),superscript:()=>l("superscript"),clearFormat:()=>l("clearFormat"),heading:o=>l("heading",o),paragraph:()=>l("paragraph"),blockquote:()=>l("blockquote"),codeBlock:()=>l("codeBlock"),orderedList:()=>l("orderedList"),unorderedList:()=>l("unorderedList"),alignLeft:()=>l("alignLeft"),alignCenter:()=>l("alignCenter"),alignRight:()=>l("alignRight"),alignJustify:()=>l("alignJustify"),indent:()=>l("indent"),outdent:()=>l("outdent"),link:o=>l("link",o),unlink:()=>l("unlink"),insertHR:()=>l("insertHR"),insertHTML:o=>l("insertHTML",o),insertText:o=>l("insertText",o),setFontSize:o=>l("setFontSize",o),setFontFamily:o=>l("setFontFamily",o),setColor:o=>l("setColor",o),setBackgroundColor:o=>l("setBackgroundColor",o),undo:()=>u.emit("undo"),redo:()=>u.emit("redo"),getHTML:()=>a.innerHTML,setHTML:o=>{let m=r.sanitize(o);a.innerHTML=m,s.pushImmediate(m,null),u.emit("change",m)},getText:()=>a.textContent||"",isEmpty:()=>(a.textContent?.trim()||"")===""&&a.children.length<=1,saveSelection:()=>i.saveSelection(),restoreSelection:()=>i.restoreSelection(),focus:()=>{a.focus(),i.restoreSelection()},blur:()=>a.blur(),getPlugin:o=>h.get(o),isReadOnly:()=>c,setReadOnly:o=>{c=o,a.contentEditable=o?"false":"true",u.emit("readOnlyChange",o)},on:(o,m)=>{f.has(o)||f.set(o,new Set),f.get(o).add(m)},off:(o,m)=>{f.get(o)?.delete(m)},emit:(o,...m)=>{f.get(o)?.forEach(g=>g(...m))},destroy:()=>{d||(d=!0,h.forEach(o=>o.destroy?.()),h.clear(),a.removeEventListener("input",x),a.removeEventListener("keydown",T),a.removeEventListener("paste",w),a.removeEventListener("focus",A),a.removeEventListener("blur",D),n.removeEventListener("selectionchange",F),a.contentEditable="false",a.classList.remove("scribe-editor","scribe-content"),a.removeAttribute("data-placeholder"),f.clear(),s.clear(),u.emit("destroy"))}},x=()=>{c||(s.push(a.innerHTML,null),u.emit("change",a.innerHTML),t.onChange?.(a.innerHTML))},T=o=>{if(!c)for(let m of b){let g=m.ctrl?o.ctrlKey||o.metaKey:!(o.ctrlKey||o.metaKey),E=m.shift?o.shiftKey:!o.shiftKey,M=m.alt?o.altKey:!o.altKey;if(o.key.toLowerCase()===m.key.toLowerCase()&&g&&E&&M){o.preventDefault(),l(m.command,...m.args||[]);return}}},w=o=>{if(c)return;o.preventDefault();let m=o.clipboardData?.getData("text/html"),g=o.clipboardData?.getData("text/plain");if(m){let E=r.sanitizePaste(m);l("insertHTML",E)}else g&&l("insertText",g)},A=()=>{u.emit("focus"),t.onFocus?.()},D=()=>{u.emit("blur"),t.onBlur?.()},F=()=>{if(!i.isSelectionInContent())return;let o=i.getSelection();u.emit("selectionChange",o),t.onSelectionChange?.(o)};return u.on("undo",()=>{let o=s.undo();o&&(a.innerHTML=o.html,u.emit("change",o.html))}),u.on("redo",()=>{let o=s.redo();o&&(a.innerHTML=o.html,u.emit("change",o.html))}),a.addEventListener("input",x),a.addEventListener("keydown",T),a.addEventListener("paste",w),a.addEventListener("focus",A),a.addEventListener("blur",D),n.addEventListener("selectionchange",F),t.plugins?.forEach(o=>{h.set(o.name,o),o.commands&&Object.entries(o.commands).forEach(([m,g])=>{p.set(m,g)}),o.shortcuts&&b.push(...o.shortcuts),o.init?.(u)}),s.pushImmediate(a.innerHTML,null),t.autofocus&&setTimeout(()=>u.focus(),0),u.emit("ready"),u}function H(t,e={}){let n=document.querySelector(t);if(!n)throw new Error(`Scribe: Element "${t}" not found`);return v({target:n,mode:"inline",...e})}var B={init:H,createEditor:v};var O={name:"bold",toolbarItems:[{name:"bold",icon:"bold",title:"Bold (Ctrl+B)",command:"bold",isActive:t=>t.bold,group:"format"}]},q={name:"italic",toolbarItems:[{name:"italic",icon:"italic",title:"Italic (Ctrl+I)",command:"italic",isActive:t=>t.italic,group:"format"}]},U={name:"underline",toolbarItems:[{name:"underline",icon:"underline",title:"Underline (Ctrl+U)",command:"underline",isActive:t=>t.underline,group:"format"}]},j={name:"strike",toolbarItems:[{name:"strike",icon:"strikethrough",title:"Strikethrough",command:"strike",isActive:t=>t.strike,group:"format"}]},K={name:"code",toolbarItems:[{name:"code",icon:"code",title:"Inline Code",command:"code",isActive:t=>t.code,group:"format"}]},W={name:"heading",toolbarItems:[{name:"h1",icon:"heading1",title:"Heading 1",command:"heading",args:[1],isActive:t=>t.heading===1,group:"block"},{name:"h2",icon:"heading2",title:"Heading 2",command:"heading",args:[2],isActive:t=>t.heading===2,group:"block"},{name:"h3",icon:"heading3",title:"Heading 3",command:"heading",args:[3],isActive:t=>t.heading===3,group:"block"}]},_={name:"list",toolbarItems:[{name:"unorderedList",icon:"list",title:"Bullet List",command:"unorderedList",isActive:t=>t.list==="unordered",group:"list"},{name:"orderedList",icon:"listOrdered",title:"Numbered List",command:"orderedList",isActive:t=>t.list==="ordered",group:"list"}]},$={name:"blockquote",toolbarItems:[{name:"blockquote",icon:"quote",title:"Quote",command:"blockquote",isActive:t=>t.blockquote,group:"block"}]},G={name:"link",toolbarItems:[{name:"link",icon:"link",title:"Link (Ctrl+K)",command:"showLinkModal",isActive:t=>!!t.link,group:"insert"}]},J={name:"alignment",toolbarItems:[{name:"alignLeft",icon:"alignLeft",title:"Align Left",command:"alignLeft",isActive:t=>t.align==="left",group:"align"},{name:"alignCenter",icon:"alignCenter",title:"Align Center",command:"alignCenter",isActive:t=>t.align==="center",group:"align"},{name:"alignRight",icon:"alignRight",title:"Align Right",command:"alignRight",isActive:t=>t.align==="right",group:"align"}]},Z={name:"clearFormat",toolbarItems:[{name:"clearFormat",icon:"removeFormatting",title:"Clear Formatting (Ctrl+\\)",command:"clearFormat",group:"misc"}]},Q={name:"history",toolbarItems:[{name:"undo",icon:"undo",title:"Undo (Ctrl+Z)",command:"undo",group:"history"},{name:"redo",icon:"redo",title:"Redo (Ctrl+Shift+Z)",command:"redo",group:"history"}]},X=[O,q,U,j,K,W,_,$,G,J,Z,Q];export{y as HTMLSanitizer,S as HistoryManager,B as Scribe,C as SelectionManager,k as coreCommands,v as createEditor,X as defaultPlugins,L as defaultShortcuts,H as init};
